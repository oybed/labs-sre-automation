---
- name: Determine Job types to process
  block:
    - name: Check for User Management Jobs
      find:
        paths: "{{ directory }}/queue"
        patterns: "user-management-*.json"
      register: jobs_user_management
  when:
    - job_queue.stat.path is defined

- name: Process Job types
  block:
    - name: Process User Management Jobs
      include: "user-management.yml"
      with_items: "{{ jobs_user_management.files }}"
      loop_control:
        loop_var: job
      when:
        - jobs_user_management is defined

- set_fact:
    user_list: []

- include_tasks: process_user.yml
  loop_control:
    loop_var: user_item
  loop: "{{ job_users }}"
  when:
    job_users is defined

- name: Assemble final list of users in remove queue
  set_fact:
    user_list: "{{ user_list.keys() | map('extract', user_list) | list | flatten | unique }}"
  when: 
    - user_list is defined
    - user_list | length > 0


- name: Create user remove list
  set_fact:
    users_remove: "{{ users_remove|d([]) + [ item | combine({'state': 'absent'})] }}"
  loop: "{{ user_list }}"



